name: WezTerm Windows Alt Icon Builds

on:
  schedule:
    - cron: "0 4 * * *"

  workflow_dispatch:
    inputs:
      debugging:
        type: boolean
        required: false
        default: false

jobs:
  get-wezterm:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-wezterm-latest.outputs.version }}
    steps:

      - name: Get WezTerm Latest Release Version Tag
        id: get-wezterm-latest
        run: |
          version=$(
            curl -s "https://api.github.com/repos/wezterm/wezterm/releases/latest" \
              | jq -r '.tag_name'
          )

          # Output the tag name using the new syntax
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Set release tag variable
        id: vars
        run: |
          echo "release_tag=${{ steps.get-wezterm-latest.outputs.version }}-alt-icons" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        run: |
          echo "Checking if tag '${{ steps.vars.outputs.release_tag }}' exists..."
          if git fetch --tags && git rev-parse "refs/tags/${{ steps.vars.outputs.release_tag }}" >/dev/null 2>&1; then
            echo "ü§∑ Tag exists, skipping release"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Cancel if tag exists
        if: ${{ steps.check_tag.outputs.exists }} == 'true'
        run: |
          echo "echo "‚ö†Ô∏è  Release tag exists, cancelling current workflow run to avoid duplicate release" Release tag exists, cancelling current workflow run to avoid duplicate release"
          gh api -X POST repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/cancel \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get WezTerm Windows Zip
        id: get-wezterm-zip
        run: |
          export wezterm_version="${{ steps.get-wezterm-latest.outputs.version }}"

          echo "wezterm_version=$wezterm_version"

          export wezterm_folder="WezTerm-windows-${wezterm_version}"
          echo "wezterm_folder=$wezterm_folder"

          export url="https://github.com/wezterm/wezterm/releases/download/${wezterm_version}/${wezterm_folder}.zip"
          echo "url=$url"

          curl -Lso temp.zip "$url"

          unzip temp.zip
          mv $wezterm_folder wezterm
          rm temp.zip

      - name: Debug version capture step one
        run: |
          echo "version: ${{ steps.get-wezterm-latest.outputs.version }}"

      - uses: actions/upload-artifact@v4
        with:
          name: wezterm.zip
          path: wezterm
          retention-days: 2

  icon-matrix:
    needs: get-wezterm
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: "Checkout Local Repo"
        uses: actions/checkout@v4

      - name: Generate Icon Matrix
        id: set-matrix
        shell: ruby {0}
        run: |
          require 'json'

          matrix = Dir.glob('alt-icons/wezterm-icon-*.png').map do |file|
            {
              file: file,
              ico: file.sub(/\.png$/, '.ico'),
              name: File.basename(file).sub(/^wezterm-icon-/, '').sub(/\.png$/, '')
            }
          end

          File.open(ENV['GITHUB_OUTPUT'], 'a') do |f|
            f.puts "matrix=#{matrix.to_json}"
          end

      - id: upload-alt-icons
        uses: actions/upload-artifact@v4
        with:
          name: alt-icons.zip
          path: alt-icons
          retention-days: 2

  patch-wezterm-icon:
    needs:
      - get-wezterm
      - icon-matrix
    env:
      version: ${{ needs.get-wezterm.outputs.version }}
    strategy:
      matrix:
        icon: ${{ fromJson(needs.icon-matrix.outputs.matrix) }}
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: wezterm.zip
          path: wezterm

      - uses: actions/download-artifact@v4
        with:
          name: alt-icons.zip
          path: alt-icons

      - name: "Remote Debugging"
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debugging }}
        with:
          detached: true

      - name: "Install Dependencies"
        shell: pwsh
        run: |
          Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
          scoop install imagemagick rcedit

      - name: "${{ matrix.icon.file }} ‚Üí ${{ matrix.icon.ico }}"
        shell: bash
        run: |
          export image="${{ matrix.icon.file }}"
          magick -background transparent -define icon:auto-resize="16,32,48,64,96,128,256" "$image" "${{ matrix.icon.ico }}"

      - name: "Create Zip Package with ${{ matrix.icon.ico }}"
        id: zip-windows-package
        shell: pwsh
        run: |
          # Import the wezterm_version from the previous step's output
          $wezterm_version = "${{ needs.get-wezterm.outputs.version }}"
          Write-Host "üñ•Ô∏è wezterm_version=$wezterm_version"

          $IconName = "${{ matrix.icon.name }}"

          # New folder name combining version and icon part
          $newFolderName = "WezTerm-windows-$IconName-$wezterm_version"

          Write-Host "Processing '$IconName'..."

          Move-Item -Path wezterm -Destination $newFolderName

          $exePath = Join-Path -Path $newFolderName -ChildPath "wezterm-gui.exe"

          Write-Host "Patching executable icon using rcedit: $exePath with icon ${{ matrix.icon.ico }}"
          ~\scoop\shims\rcedit.exe $exePath --set-icon ${{ matrix.icon.ico }}

          Write-Host "üéâ Done processing $IconName."

      - name: "üçπ Upload artifact"
        uses: actions/upload-artifact@v4
        with:
          name: "WezTerm-windows-${{ matrix.icon.name }}-${{ env.version }}.zip"
          path: "WezTerm-windows-${{ matrix.icon.name }}-${{ env.version }}"
          retention-days: 2

